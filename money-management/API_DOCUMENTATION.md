# æ™ºèƒ½æ ¡å›­è®°è´¦åŠ©æ‰‹ API æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æ™ºèƒ½æ ¡å›­è®°è´¦åŠ©æ‰‹åç«¯æœåŠ¡çš„ API æ¥å£ã€‚è¯¥æœåŠ¡åŸºäº FastAPI æ„å»ºï¼Œæ”¯æŒå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»ã€‚

## ğŸ“ åŸºæœ¬ä¿¡æ¯

- **åŸºç¡€ URL**: `http://127.0.0.1:9090` (é»˜è®¤æœ¬åœ°è¿è¡Œç«¯å£)
- **åè®®**: HTTP/1.1
- **æ•°æ®æ ¼å¼**: JSON

## ğŸ” å¤šç§Ÿæˆ·ä¸è®¤è¯

æœ¬é¡¹ç›®é‡‡ç”¨**ç”¨æˆ· ID (user_id)** è¿›è¡Œé€»è¾‘éš”ç¦»ã€‚
*   æ‰€æœ‰è¯·æ±‚å¿…é¡»åœ¨ Query å‚æ•°æˆ– Request Body ä¸­æºå¸¦ `user_id`ã€‚
*   ä¸åŒç”¨æˆ·çš„è´¦å•æ•°æ®å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å¯è§ã€‚

---

## ğŸ“š æ¥å£åˆ—è¡¨

### 1. è®°è´¦ (Create Expense)

åˆ›å»ºä¸€æ¡æ–°çš„æ¶ˆè´¹è®°å½•ã€‚

- **URL**: `/expenses/`
- **Method**: `POST`
- **Request Body (JSON)**:

| å­—æ®µ | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `amount` | float | æ˜¯ | æ¶ˆè´¹é‡‘é¢ |
| `category` | string | æ˜¯ | æ¶ˆè´¹ç±»åˆ« (å¦‚ï¼šé¤é¥®, äº¤é€š, å­¦ä¹ ) |
| `item-name` | string | æ˜¯ | å…·ä½“æ¶ˆè´¹é¡¹ç›®åç§° (æ³¨æ„å­—æ®µåå«è¿å­—ç¬¦) |
| `transaction_date` | datetime | å¦ | äº¤æ˜“æ—¶é—´ (é»˜è®¤å½“å‰æ—¶é—´) |

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
  "user_id": "student_001",
  "amount": 25.5,
  "category": "é¤é¥®",
  "item-name": "é»„ç„–é¸¡ç±³é¥­",
  "transaction_date": "2023-10-27T12:30:00"
}
```

**å“åº”ç¤ºä¾‹ (200 OK)**:

```json
{
  "user_id": "student_001",
  "amount": 25.5,
  "category": "é¤é¥®",
  "item_name": "é»„ç„–é¸¡ç±³é¥­",
  "transaction_date": "2023-10-27T12:30:00",
  "id": 1,
  "created_at": "2023-10-27T12:30:00.123456"
}
```

---

### 2. æŸ¥è´¦ (Read Expenses)

æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ¶ˆè´¹è®°å½•åˆ—è¡¨ã€‚

- **é€»è¾‘**: å¦‚æœä¸æŒ‡å®š `date` å‚æ•°ï¼Œé»˜è®¤è¿”å›**æœ€è¿‘ 7 å¤©**çš„è®°å½•ã€‚
- **URL**: `/expenses/`
- **Method**: `GET`
- **Query Parameters**:

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `category` | string | å¦ | æ¶ˆè´¹åˆ†ç±»ï¼Œä¾‹å¦‚ `é¤é¥®`ã€`äº¤é€š` |
| `date` | datetime | å¦ | ç‰¹å®šæ—¥æœŸ (ISOæ ¼å¼)ï¼Œä¾‹å¦‚ `2023-10-27` (æŸ¥è¯¢è¯¥æ—¥æ‰€æœ‰è®°å½•) |

**è¯·æ±‚ç¤ºä¾‹**:
1. **é»˜è®¤æŸ¥è¯¢ (æœ€è¿‘7å¤©)**:
   `GET /expenses/?user_id=student_001`

2. **æŒ‰åˆ†ç±»æŸ¥è¯¢**:
   `GET /expenses/?user_id=student_001&category=é¤é¥®`

3. **æŸ¥è¯¢ç‰¹å®šæ—¥æœŸ**:
   `GET /expenses/?user_id=student_001&date=2023-10-27`

**å“åº”ç¤ºä¾‹ (200 OK)**:

```json
{
  "expenses": [
    {
      "user_id": "student_001",
      "amount": 25.5,
      "category": "é¤é¥®",
      "item_name": "é»„ç„–é¸¡ç±³é¥­",
      "transaction_date": "2023-10-27T12:30:00",
      "id": 1,
      "created_at": "2023-10-27T12:30:00"
    }
  ]
}
```

### 3. åˆ é™¤æ¶ˆè´¹ (Delete Expenses)

åˆ é™¤æ¶ˆè´¹è®°å½•ã€‚å¯ä»¥é€šè¿‡æ—¥æœŸåˆ é™¤å½“å¤©çš„æ‰€æœ‰è®°å½•ï¼Œæˆ–è€…é€šè¿‡IDåˆ é™¤å•æ¡è®°å½•ã€‚

- **URL**: `/expenses/`
- **Method**: `DELETE`
- **Query Parameters** (äºŒé€‰ä¸€å¿…å¡«):

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `date` | datetime | å¦ | åˆ é™¤è¯¥æ—¥æœŸçš„æ‰€æœ‰è®°å½• (ISOæ ¼å¼)ï¼Œä¾‹å¦‚ `2023-10-27` |
| `expense_id` | integer | å¦ | åˆ é™¤æŒ‡å®š ID çš„å•æ¡è®°å½•ï¼Œä¾‹å¦‚ `1` |

**è¯·æ±‚ç¤ºä¾‹**:

1. **æŒ‰æ—¥æœŸåˆ é™¤ (åˆ é™¤ä¸€å¤©)**:
   `DELETE /expenses/?user_id=student_001&date=2023-10-27`

2. **æŒ‰IDåˆ é™¤ (åˆ é™¤ä¸€æ¡)**:
   `DELETE /expenses/?user_id=student_001&expense_id=42`

**å“åº”ç¤ºä¾‹ (200 OK)**:
```json
{
  "message": "Deleted 1 expenses."
}
```

### 4. å‘¨æŠ¥ç»Ÿè®¡ (Weekly Report)

è·å–æŒ‰ç±»åˆ«èšåˆçš„æ¶ˆè´¹ç»Ÿè®¡æ•°æ®ã€‚

- **URL**: `/report/weekly`
- **Method**: `GET`
- **Query Parameters**:

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |

**å“åº”ç¤ºä¾‹ (200 OK)**:

```json
{
  "user_id": "student_001",
  "summary": [
    {
      "category": "é¤é¥®",
      "total": 150.0
    },
    {
      "category": "äº¤é€š",
      "total": 50.0
    }
  ],
  "total_expense": 200.0
}
```

---

### 4. å¯è§†åŒ–å‘¨æŠ¥ (Visual Report)

ç”ŸæˆåŒ…å«â€œæ¶ˆè´¹å æ¯”â€å’Œâ€œæ¯æ—¥è¶‹åŠ¿â€çš„èµ›åšæœ‹å…‹é£æ ¼å¯è§†åŒ–æŠ¥è¡¨ã€‚

> **ä¼˜åŒ–è¯´æ˜**: ä¸ºé€‚é…æ™ºèƒ½ä½“å¹³å°ï¼ˆé¿å… Token æ¶ˆè€—è¿‡å¤§ï¼‰ï¼Œæœ¬æ¥å£ç°åœ¨è¿”å›å›¾ç‰‡çš„ URL è€Œé Base64 ç¼–ç ã€‚æ™ºèƒ½ä½“åº”å°†æ­¤ URL æ¸²æŸ“ä¸º Markdown å›¾ç‰‡ã€‚

- **URL**: `/analysis/visual_report`
- **Method**: `GET`
- **Query Parameters**:

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |

**å“åº”ç¤ºä¾‹ (200 OK)**:

```json
{
  "image_url": "http://127.0.0.1:9090/static/report_student_001_1703666000.png",
  "tips": "Agent should render this as a Markdown image: ![](http://127.0.0.1:9090/static/report_student_001_1703666000.png)"
}
```

---

### 5. æ¯’èˆŒ AI è´¢è¿é¢„æµ‹ (Toxic Prediction)

åŸºäºå½“å‰æ¶ˆè´¹è¿›åº¦ï¼Œæä¾›â€œæ¯’èˆŒâ€é£æ ¼çš„æœˆåº•æ”¯å‡ºé¢„æµ‹ä¸ç‚¹è¯„ã€‚

- **URL**: `/analysis/toxic_prediction`
- **Method**: `GET`
- **Query Parameters**:

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `user_id` | string | æ˜¯ | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `budget` | float | å¦ | æœˆåº¦é¢„ç®— (é»˜è®¤ 2000.0) |

**å“åº”ç¤ºä¾‹ (200 OK)**:

```json
{
  "report": "### ğŸ”® æ¯’èˆŒAI è´¢è¿é¢„æµ‹\n\n- **å½“å‰å·²èŠ±**: 3144.00 å…ƒ\n- **æœ¬æœˆè¿›åº¦**: 8/31 å¤©...\n\n**ğŸ’€ ä¸¥é‡è¶…æ”¯è­¦å‘Š**\n\n> å‘µå‘µï¼Œç…§ä½ è¿™ä¸ªèŠ±æ³•ï¼Œæœˆåº•å‡†å¤‡åƒåœŸå§ï¼..."
}
```

## âš ï¸ é”™è¯¯å¤„ç†

è‹¥å‘ç”Ÿè¯·æ±‚éªŒè¯é”™è¯¯ï¼ˆå¦‚ç¼ºå°‘ `user_id`ï¼‰ï¼ŒæœåŠ¡å™¨å°†è¿”å› `422 Unprocessable Entity`ã€‚

```json
{
  "detail": [
    {
      "loc": ["query", "user_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```
