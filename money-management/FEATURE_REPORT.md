# 校园记账助手 - 新增高级分析功能报告

**日期**: 2025-02-07
**模块**: 数据分析服务 (Analysis Service)

本更新为校园记账助手后端添加了基于数据分析的高级功能，旨在通过可视化和趣味性反馈提升用户体验，并针对智能体（AI Agent）平台进行了专项适配。

## 🚀 新增功能概览

### 1. 📊 可视化周报 (Visual Report)

为用户生成直观的消费图表，帮助快速了解财务状况。

- **功能描述**: 生成一张**赛博朋克风格 (Cyberpunk)** 的数据看板图片。
- **图表构成**:
  - **左上 (摘要)**: 关键指标卡片，展示总支出、最大消费类别及金额。
  - **右上 (甜甜圈图)**: 现代化的环形图展示各分类占比，霓虹配色。**智能合并小额类别**（占比<5%自动归为“其他”），避免标签拥挤。
  - **下方 (发光面积图)**: 带有渐变发光效果的趋势图，展示每日消费波动。
- **技术亮点**:
  - **智能体适配 (Agent-Ready)**: 接口不再返回 Base64，而是自动将图片保存为静态文件并返回 **URL**。这大大降低了 Token 消耗，使智能体能够流畅地以 Markdown 图片形式渲染报表。
  - **Dark Mode**: 采用深色背景 (`#212946`) 配合高亮霓虹色 (`#08F7FE`, `#FE53BB`)，视觉冲击力强。
  - **布局升级**: 使用 `GridSpec` 实现非对称的仪表盘布局，告别呆板的子图排列。
  - **自动解决中文乱码**: 内置字体检测逻辑，自动适配 Windows (SimHei/YaHei), macOS (Arial Unicode MS) 和 Linux (WenQuanYi)。
- **API 接口**: `GET /analysis/visual_report?user_id={user_id}`

### 2. 😈 毒舌 AI 趋势预测 (Toxic Prediction)

基于用户当前的消费速度，预测月底账单，并配以“毒舌”风格的评价。

- **功能描述**: 根据当前日期、已花金额和剩余天数，线性预测月底总消费，并与设定预算（默认 2000 元）对比。
- **反馈机制**:
  - **💀 严重超支 (>500 元)**: 语气尖酸刻薄，嘲讽用户败家。
  - **⚠️ 轻微超支 (>0 元)**: 语气警告，带有紧迫感。
  - **💅 未超支**: 语气傲娇，勉强夸奖。
- **输出格式**: Markdown 格式的文本报告。
- **API 接口**: `GET /analysis/toxic_prediction?user_id={user_id}&budget={budget}`

### 3. 🔍 增强型查账 (Enhanced Query)

查账接口全面升级，支持更细粒度的筛选，满足用户多维度的查询需求。

- **功能描述**: 在原有基础上，新增了按**分类**和**特定日期**查询的功能。
- **查询维度**:
  - **按分类**: 例如查询所有“餐饮”类别的消费。
  - **按日期**: 查询某一天的所有消费记录（如 `2023-10-27`）。
  - **按范围**: 保持原有的日期范围查询。
- **API 接口**: `GET /expenses/?user_id={user_id}&category={category}&date={date}`

## 🛠 技术栈与架构更新

为了支持上述功能，项目进行了以下架构调整：

- **静态资源服务**: 新增 `/static` 目录挂载，用于托管生成的报表图片。
- **数据科学库**:
  - **Pandas**: 用于高效的数据清洗、聚合和时间序列处理。
  - **Matplotlib / Seaborn**: 绘制高质量统计图表。

## 📝 核心代码文件

- `analysis_service.py`: 封装了所有绘图和预测逻辑，包含图表优化算法（如小额类别合并）。
- `main.py`: 更新了 FastAPI 路由，集成了新的分析接口及静态文件服务。
- `test_features.py`: 包含了完整的集成测试脚本，可自动生成测试数据并验证接口返回。
- `API_DOCUMENTATION.md`: 新增的完整接口文档。
- `openapi.json`: 标准 OpenAPI 规范文档，方便导入第三方工具。

## ✅ 测试结果

已编写并运行 `test_features.py`，验证通过：

1.  **中文适配**: 能够正确处理中文数据并生成无乱码图片。
2.  **智能体兼容性**: 接口正确返回图片 URL，且该 URL 可在浏览器中直接访问。
3.  **逻辑正确性**: 毒舌预测能够根据预算差异返回不同语气的文案。
