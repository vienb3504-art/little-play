# 校园记账助手 - 新增高级分析功能报告

**日期**: 2025-02-07
**模块**: 数据分析服务 (Analysis Service)

本更新为校园记账助手后端添加了基于数据分析的高级功能，旨在通过可视化和趣味性反馈提升用户体验。

## 🚀 新增功能概览

### 1. 📊 可视化周报 (Visual Report)

为用户生成直观的消费图表，帮助快速了解财务状况。

- **功能描述**: 生成一张包含“消费占比”和“每日趋势”的组合图片。
- **图表构成**:
  - **左侧 (饼图)**: 展示各分类（如餐饮、交通、学习）的消费占比。
  - **右侧 (折线图)**: 展示选定时间范围内的每日消费金额变化趋势。
- **技术亮点**:
  - 使用 `matplotlib` 和 `seaborn` 进行绘图，配色现代（Pastel/Muted）。
  - **自动解决中文乱码**: 内置字体检测逻辑，自动适配 Windows (SimHei/YaHei), macOS (Arial Unicode MS) 和 Linux (WenQuanYi)。
  - **内存处理**: 图片直接在内存中生成并转换为 Base64 编码，无需产生临时文件。
- **API 接口**: `GET /analysis/visual_report?user_id={user_id}`

### 2. 😈 毒舌 AI 趋势预测 (Toxic Prediction)

基于用户当前的消费速度，预测月底账单，并配以“毒舌”风格的评价。

- **功能描述**: 根据当前日期、已花金额和剩余天数，线性预测月底总消费，并与设定预算（默认 2000 元）对比。
- **反馈机制**:
  - **💀 严重超支 (>500 元)**: 语气尖酸刻薄，嘲讽用户败家。
  - **⚠️ 轻微超支 (>0 元)**: 语气警告，带有紧迫感。
  - **💅 未超支**: 语气傲娇，勉强夸奖。
- **输出格式**: Markdown 格式的文本报告。
- **API 接口**: `GET /analysis/toxic_prediction?user_id={user_id}&budget={budget}`

## 🛠 技术栈更新

为了支持上述功能，项目引入了以下数据科学库：

- **Pandas**: 用于高效的数据清洗、聚合和时间序列处理。
- **Matplotlib**: 基础绘图引擎。
- **Seaborn**: 基于 Matplotlib 的高级绘图库，提供更美观的默认样式。

## 📝 核心代码文件

- `analysis_service.py`: 封装了所有绘图和预测逻辑，保持业务逻辑分离。
- `main.py`: 更新了 FastAPI 路由，集成了新的分析接口。
- `test_features.py`: 包含了完整的集成测试脚本，可自动生成测试数据并验证接口返回。

## ✅ 测试结果

已编写并运行 `test_features.py`，验证通过：

1.  能够正确处理中文数据并生成无乱码图片。
2.  能够根据预算差异返回不同语气的毒舌文案。
