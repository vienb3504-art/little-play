<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ ¡å›­è®°è´¦åŠ©æ‰‹ - æ¨¡æ‹Ÿç»ˆç«¯</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .json-pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.875rem; }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-6 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ¤– æ™ºèƒ½ä½“æ¥å£æ¨¡æ‹Ÿç»ˆç«¯</h1>
            <p class="text-gray-600 mt-2">æ¨¡æ‹Ÿä¸åŒç”¨æˆ·èº«ä»½è°ƒç”¨åç«¯ API</p>
        </header>

        <!-- ç”¨æˆ·è®¾ç½® -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <span class="bg-blue-100 text-blue-600 p-2 rounded-full mr-2">ğŸ‘¤</span> 
                å½“å‰æ¨¡æ‹Ÿèº«ä»½
            </h2>
            <div class="flex gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">User ID (å¿…å¡«)</label>
                    <input v-model="userId" type="text" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹å¦‚: user_001">
                </div>
                <div class="text-sm text-gray-500 pb-2">
                    æ‰€æœ‰æ“ä½œéƒ½å°†åŸºäºæ­¤ ID è¿›è¡Œéš”ç¦»æµ‹è¯•
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šè®°è´¦æ“ä½œ -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-green-100 text-green-600 p-2 rounded-full mr-2">ğŸ’°</span> 
                    è®°è´¦ (POST)
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¶ˆè´¹é¡¹ç›®</label>
                        <input v-model="expenseForm.item_name" type="text" class="w-full p-2 border border-gray-300 rounded-md" placeholder="ä¾‹å¦‚: é»„ç„–é¸¡ç±³é¥­">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¢</label>
                            <input v-model.number="expenseForm.amount" type="number" class="w-full p-2 border border-gray-300 rounded-md" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»</label>
                            <select v-model="expenseForm.category" class="w-full p-2 border border-gray-300 rounded-md">
                                <option>é¤é¥®</option>
                                <option>äº¤é€š</option>
                                <option>è´­ç‰©</option>
                                <option>å¨±ä¹</option>
                                <option>å­¦ä¹ </option>
                                <option>å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <button @click="createExpense" :disabled="loading" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition disabled:opacity-50">
                        {{ loading ? 'æäº¤ä¸­...' : 'æäº¤è®°è´¦' }}
                    </button>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šæŸ¥è¯¢æ“ä½œ -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-purple-100 text-purple-600 p-2 rounded-full mr-2">ğŸ“Š</span> 
                    æŸ¥è´¦ & ç»Ÿè®¡ (GET)
                </h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">æ—¥æœŸ (å¯é€‰)</label>
                            <input v-model="queryDate" type="date" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">åˆ†ç±» (å¯é€‰)</label>
                            <select v-model="queryCategory" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                                <option value="">æ‰€æœ‰åˆ†ç±»</option>
                                <option>é¤é¥®</option>
                                <option>äº¤é€š</option>
                                <option>è´­ç‰©</option>
                                <option>å¨±ä¹</option>
                                <option>å­¦ä¹ </option>
                                <option>å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">æ¡æ•° (å¯é€‰)</label>
                            <input v-model.number="queryLimit" type="number" class="w-full p-2 border border-gray-300 rounded-md text-sm" placeholder="é™åˆ¶æ¡æ•°">
                        </div>
                    </div>
                    <button @click="fetchExpenses" :disabled="loading" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition disabled:opacity-50 flex justify-between items-center">
                        <span>æŸ¥è¯¢è´¦å•åˆ—è¡¨</span>
                        <span class="text-xs opacity-75">GET /expenses/query</span>
                    </button>
                    <button @click="fetchReport" :disabled="loading" class="w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition disabled:opacity-50 flex justify-between items-center">
                        <span>æŸ¥çœ‹å‘¨æŠ¥ç»Ÿè®¡</span>
                        <span class="text-xs opacity-75">GET /report/weekly</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šåˆ é™¤æ“ä½œ -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="bg-red-100 text-red-600 p-2 rounded-full mr-2">ğŸ—‘ï¸</span> 
                    åˆ é™¤æ“ä½œ (GET)
                </h2>
                <div class="space-y-4">
                    <!-- Delete by Date -->
                    <div class="border-b pb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒ‰æ—¥æœŸåˆ é™¤</label>
                        <div class="flex gap-2">
                            <input v-model="deleteDate" type="date" class="flex-1 p-2 border border-gray-300 rounded-md">
                            <button @click="deleteByDate" :disabled="loading || !deleteDate" class="bg-red-500 text-white px-4 rounded-md hover:bg-red-600 disabled:opacity-50 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                    <!-- Delete by ID -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æŒ‰ ID åˆ é™¤</label>
                        <div class="flex gap-2">
                            <input v-model="deleteId" type="number" class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Expense ID">
                            <button @click="deleteById" :disabled="loading || !deleteId" class="bg-red-500 text-white px-4 rounded-md hover:bg-red-600 disabled:opacity-50 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div class="mt-6 bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center justify-between">
                <div class="flex items-center">
                    <span class="bg-gray-100 text-gray-600 p-2 rounded-full mr-2">ğŸ“</span> 
                    API å“åº”ç»“æœ
                </div>
                <button @click="logs = []" class="text-sm text-red-500 hover:text-red-700">æ¸…ç©ºæ—¥å¿—</button>
            </h2>
            
            <div v-if="logs.length === 0" class="text-center text-gray-400 py-8">
                æš‚æ— æ“ä½œè®°å½•
            </div>
            <div v-else class="space-y-4">
                <div v-for="(log, index) in logs" :key="index" class="border-l-4 pl-4" :class="log.type === 'error' ? 'border-red-500' : 'border-blue-500'">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold" :class="log.type === 'error' ? 'text-red-600' : 'text-blue-600'">{{ log.action }}</span>
                        <span class="text-gray-500">{{ log.time }}</span>
                    </div>
                    <pre class="json-pre">{{ log.data }}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const API_BASE = 'http://127.0.0.1:9090';

        createApp({
            setup() {
                const userId = ref('user_001');
                const loading = ref(false);
                const logs = ref([]);
                
                const queryDate = ref('');
                const queryCategory = ref('');
                const queryLimit = ref('');
                const deleteDate = ref('');
                const deleteId = ref('');

                const expenseForm = reactive({
                    amount: '',
                    category: 'é¤é¥®',
                    item_name: ''
                });

                const addLog = (action, data, type = 'success') => {
                    logs.value.unshift({
                        action,
                        data: JSON.stringify(data, null, 2),
                        time: new Date().toLocaleTimeString(),
                        type
                    });
                };

                const createExpense = async () => {
                    if (!userId.value) return alert('è¯·è¾“å…¥ User ID');
                    if (!expenseForm.amount || !expenseForm.item_name) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

                    loading.value = true;
                    try {
                        const payload = {
                            user_id: userId.value,
                            amount: parseFloat(expenseForm.amount),
                            category: expenseForm.category,
                            item_name: expenseForm.item_name
                        };

                        const res = await fetch(`${API_BASE}/expenses/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        
                        if (res.ok) {
                            addLog(`è®°è´¦æˆåŠŸ (${userId.value})`, data);
                            // æ¸…ç©ºè¡¨å•éƒ¨åˆ†å­—æ®µ
                            expenseForm.amount = '';
                            expenseForm.item_name = '';
                        } else {
                            addLog('è®°è´¦å¤±è´¥', data, 'error');
                        }
                    } catch (e) {
                        addLog('è¯·æ±‚é”™è¯¯', { error: e.message }, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchExpenses = async () => {
                    if (!userId.value) return alert('è¯·è¾“å…¥ User ID');
                    loading.value = true;
                    try {
                        let url = `${API_BASE}/expenses/query?user_id=${userId.value}`;
                        if (queryDate.value) url += `&date=${queryDate.value}`;
                        if (queryCategory.value) url += `&category=${queryCategory.value}`;
                        if (queryLimit.value) url += `&limit=${queryLimit.value}`;
                        
                        const res = await fetch(url);
                        const data = await res.json();
                        addLog(`æŸ¥è¯¢è´¦å• (${userId.value})`, data);
                    } catch (e) {
                        addLog('è¯·æ±‚é”™è¯¯', { error: e.message }, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchReport = async () => {
                    if (!userId.value) return alert('è¯·è¾“å…¥ User ID');
                    loading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/report/weekly?user_id=${userId.value}`);
                        const data = await res.json();
                        addLog(`æŸ¥çœ‹å‘¨æŠ¥ (${userId.value})`, data);
                    } catch (e) {
                        addLog('è¯·æ±‚é”™è¯¯', { error: e.message }, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const performDelete = async (queryString, actionName) => {
                    if (!userId.value) return alert('è¯·è¾“å…¥ User ID');
                    loading.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/expenses/delete?user_id=${userId.value}&${queryString}`, {
                            method: 'GET'
                        });
                        const data = await res.json();
                        if (res.ok) {
                            addLog(`${actionName} æˆåŠŸ`, data);
                        } else {
                            addLog(`${actionName} å¤±è´¥`, data, 'error');
                        }
                    } catch (e) {
                        addLog('è¯·æ±‚é”™è¯¯', { error: e.message }, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const deleteByDate = async () => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${deleteDate.value} çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) return;
                    await performDelete(`date=${deleteDate.value}`, `åˆ é™¤æ—¥æœŸ ${deleteDate.value}`);
                };

                const deleteById = async () => {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ID ä¸º ${deleteId.value} çš„è®°å½•å—ï¼Ÿ`)) return;
                    await performDelete(`expense_id=${deleteId.value}`, `åˆ é™¤ ID ${deleteId.value}`);
                };

                return {
                    userId,
                    expenseForm,
                    loading,
                    logs,
                    queryDate, 
                    queryCategory, 
                    queryLimit,
                    deleteDate, 
                    deleteId,
                    createExpense,
                    fetchExpenses,
                    fetchReport,
                    deleteByDate,
                    deleteById
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
